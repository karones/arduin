#include <EEPROM.h>
#include <DI.h>
#include <Timer_P.h>
#define eerom_byte 512
#define txPin 50
#define Te 320
#define Button1 2
DI Key(Button1, 10);
Timer_P KeyDelay;
boolean Key_old;
volatile int i;

unsigned long incomingByte; 
void setup(){
   attachInterrupt(1, saveAndStopping, RISING);
  pinMode(txPin, OUTPUT);
  Serial.begin(9600); 
Serial.setTimeout(4);
}

void loop()
{
  if (Serial.available() > 0) { 
incomingByte = Serial.parseInt(); 
if(incomingByte == -1) erase() ;
if(incomingByte == 1) SendCame(0b100010001111) ;
if(incomingByte == 2) SendCame(0b100010001110) ; 
if(incomingByte == 3) SendCame(0b100010001100) ;
if(incomingByte == 4) SendCame(0b100110001100) ;
if(incomingByte == 5) SendCame(0b101010001100) ;
if(incomingByte == 6) SendCame(0b110010001100) ;
if(incomingByte == 7) SendCame(0b100010101100) ;
if(incomingByte == 8) SendCame(0b100001010100) ;

if(incomingByte == 9) SendCame(0b100010001111) ;
if(incomingByte == 10) SendCame(0b100010001110) ; 
if(incomingByte == 11) SendCame(0b100010001100) ;
if(incomingByte == 12) SendCame(0b100110001100) ;
if(incomingByte == 13) SendCame(0b101010001100) ;
if(incomingByte == 14) SendCame(0b110010001100) ;
if(incomingByte == 15) SendCame(0b100010101100) ;
if(incomingByte == 16) SendCame(0b100001010100) ;
if(incomingByte == 16) SendCame(0b100001010100) ;
if(incomingByte == 20) perebor() ;
if(incomingByte >100) perebor_to_int(incomingByte) ;
}
 Key.DI_Refresh();

	  if (!Key.DI_Read() && Key_old && !KeyDelay.Q0()) Serial.println("Shot"); // Было короткое нажатие

	  if (!Key.DI_Read() && Key_old && KeyDelay.Q0()) perebor(); // Было длинное нажатие

  KeyDelay.TimerV(Key.DI_Read(), 0, 2, 1000);                  // 1000мс для длительного нажатия
  	  Key_old = Key.DI_Read();
}


void perebor_to_int (int k)
{
 for ( i=k; i<4096; i++)
{
  SendCame(i);
  if (i%100 ==0)
  {
    Serial.println(i);
  }
}
  
}

void perebor ()
{
 for ( i=0; i<4096; i++)
{
  SendCame(i);
  if (i%100 ==0)
  {
    Serial.println(i);
  }
}
  
}
void SendCameBit(byte b)
{
  delayMicroseconds(Te);
  if (!b) digitalWrite(txPin,HIGH);
  delayMicroseconds(Te);
  digitalWrite(txPin,HIGH);
  delayMicroseconds(Te);
  digitalWrite(txPin,LOW);
}

void SendCame(long Code)
{     
  
  for (int j=0;j<5;j++) // посылку посылаем как и брелок - 4 раза подряд.
  {
    digitalWrite(txPin,HIGH);
    delayMicroseconds(Te);
    digitalWrite(txPin,LOW);// посылаем стартовый импульс
    
    for (byte bi=12;bi>0;bi--){
      SendCameBit(bitRead(Code, bi-1)); // побитово перебираем и посылаем код
    }
    delay(16);
  }
  delay(50); 
}
void erase(){
for (int ei=0;ei<eerom_byte;ei++)
     EEPROM.write(ei, 0);
  
Serial.println("EEPROM clear");
}
void stoping()
{
 i = 5000; 
}
void saveAndStoping()
{
   EEPROM.write(i, 0);
 i = 5000; 
}
